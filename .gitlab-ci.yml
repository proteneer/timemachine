stages:          # List of stages for jobs, and their order of execution
  - build-docker
  - test


docker_build:
  stage: build-docker
  image: docker:20.10
  script:
    - DOCKER_HOST=tcp://localhost:2375 docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA --target tm_base_env .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA

memory-tests:
  stage: test
  image: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  needs: ["docker_build"]
  variables:
    CMAKE_ARGS: -DCUDA_ARCH=75
  script:
    - CMAKE_BUILD_PARALLEL_LEVEL=$(nproc) pip install -e .[dev,test]
    - make verify memcheck_tests
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME-memtests"
    paths:
        - coverage/
    when: on_success
    expire_in: 1 week

unit-tests:
  stage: test
  image: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  needs: ["docker_build"]
  variables:
    CMAKE_ARGS: -DCUDA_ARCH=75
  script:
    - CMAKE_BUILD_PARALLEL_LEVEL=$(nproc) pip install -e .[dev,test]
    - make verify tests
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME-tests"
    paths:
        - coverage/
    when: on_success
    expire_in: 1 week
